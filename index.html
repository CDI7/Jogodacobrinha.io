<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Jogo da Cobrinha</title>
<style>
        /* --- GERAL & RESET --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1d2d 0%, #11131e 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            touch-action: none;
            user-select: none;
            overflow: hidden;
        }

        /* --- CONTAINER PRINCIPAL --- */
        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 400px;
            max-height: 95vh;
            overflow-y: auto;
        }
        /* Custom scrollbar for webkit browsers */
        .game-container::-webkit-scrollbar {
            width: 5px;
        }
        .game-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .game-container::-webkit-scrollbar-track {
            background: transparent;
        }


        /* --- TIPOGRAFIA --- */
        .main-title {
            font-size: 2.5em;
            color: #ffffff;
            font-weight: 700;
            margin-bottom: 25px;
        }

        h1, h2, h3, h4 {
            color: #ffffff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        p, label {
            color: #d1d1d1;
            font-size: 14px;
        }

        a {
            color: #4a72ff;
            text-decoration: none;
            font-weight: 600;
        }

        a:hover {
            text-decoration: underline;
        }
        
        /* ALTERAÇÃO: Título para as seções de dificuldade e mapa */
        .selection-title {
            color: #ffffff;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            text-align: center;
        }

        /* --- BOTÕES --- */
        .btn {
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            padding: 12px 24px;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #4a72ff;
            box-shadow: 0 4px 15px rgba(74, 114, 255, 0.2);
        }

        .btn-primary:hover {
            background-color: #5a82ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 114, 255, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #d63031;
        }
        .btn-danger:hover {
            background: #e17055;
        }

        .start-btn {
            width: 100%;
            margin-bottom: 20px; /* Adjusted margin */
        }

        .restart-btn {
            margin-top: 15px;
        }

        /* --- FORMULÁRIOS E INPUTS --- */
        .name-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
            width: 100%;
            text-transform: uppercase;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            text-transform: none;
        }

        .name-input:focus {
            outline: none;
            border-color: #4a72ff;
            background-color: rgba(0, 0, 0, 0.3);
        }


        /* --- TELA PRINCIPAL DO JOGO --- */
        #mainGame { display: none; position: relative; }

        canvas {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            background: #11131e;
            width: 100%;
            max-width: 360px;
            height: auto;
            margin: 15px 0;
        }

        .player-score-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 15px; /* Added margin-top */
            padding: 0 5px;
            font-size: 16px;
            color: white;
        }

        .current-difficulty {
            color: white;
            font-size: 14px;
            margin-top: 10px; /* Adjusted margin */
            opacity: 0.8;
        }

        /* --- LEADERBOARD --- */
        .leaderboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px; /* Adjusted margin */
            color: white;
        }
        .leaderboard h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 8px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
        .leaderboard-difficulty {
            font-size: 12px;
            opacity: 0.8;
            margin-left: 8px;
        }

        /* --- SELEÇÃO DE DIFICULDADE E MAPA --- */
        .difficulty-selection, .map-selection {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .difficulty-selection {
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 5px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .difficulty-selection::-webkit-scrollbar {
            display: none;
        }
        
        .map-selection {
             flex-wrap: wrap;
        }

        /* ALTERAÇÃO: Botões de dificuldade com tamanho reduzido */
        .difficulty-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid transparent;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s ease;
            flex-shrink: 0; 
            width: 68px;
            height: 68px;
            line-height: 1.3;
            text-align: center;
        }

        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .difficulty-btn.selected {
            background: #4a72ff;
            border-color: transparent;
            color: white;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(74, 114, 255, 0.3);
        }
        
        .difficulty-info {
            color: #d1d1d1;
            font-size: 12px;
            margin-top: 8px;
            width: 100%;
            text-align: center;
            min-height: 28px;
        }

        /* --- CONTROLES --- */
        .controls {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            width: 200px;
            height: 120px;
            margin-left: auto;
            margin-right: auto;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.25);
        }
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }

        .pause-btn, .quit-game-btn {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 14px;
        }
        #quitGameBtn { margin-left: 10px; }


        /* --- MODAIS E TELAS DE SOBREPOSIÇÃO (GAME OVER, PARABÉNS) --- */
        .game-over, #congratulationsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(26, 29, 45, 0.9);
            backdrop-filter: blur(5px);
            z-index: 2000;
            color: white;
            padding: 20px;
        }
        .game-over h2, #congratulationsScreen h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 15px #FFD700;
        }
        #congratulationsScreen h2 {
            animation: congrats-pulse 1s infinite alternate;
        }
        @keyframes congrats-pulse {
            to { transform: scale(1.05); text-shadow: 0 0 25px #FFD700; }
        }

        /* --- FOGOS DE ARTIFÍCIO --- */
        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 1;
            animation: firework-explode 1.2s forwards;
        }
        @keyframes firework-explode {
            100% { transform: scale(30); opacity: 0; }
        }


        /* --- CONFIGURAÇÕES E ABAS --- */
        .settings-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .settings-tabs::-webkit-scrollbar { display: none; }

        .tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-button:hover { color: white; }
        .tab-button.selected {
            color: white;
            border-bottom: 3px solid #4a72ff;
            font-weight: 600;
        }

        .settings-tab-content { padding-top: 10px; text-align: left; }
        .settings-tab-content h4 { margin-top: 20px; margin-bottom: 10px; font-size: 16px; color: white; }
        .settings-tab-content label { display: block; margin-bottom: 8px; font-weight: 500; }
        .settings-tab-content input[type="color"], .settings-tab-content input[type="range"], .settings-tab-content select {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }

        /* --- SELETOR DE IDIOMA --- */
        .language-selector {
            position: absolute;
            top: 15px;
            right: 60px;
            z-index: 1000;
        }
        .language-selector-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            width: 40px;
            height: 30px;
        }
        .language-selector-button img { width: 100%; border-radius: 4px; }
        .language-selector-dropdown {
            position: absolute;
            top: 110%;
            left: 0;
            background: #2a2d3d;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 100;
            min-width: 120px;
            display: none;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .language-selector-dropdown.show { display: block; }
        .language-selector-option {
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .language-selector-option:hover { background: #4a72ff; }
        .language-selector-option img { width: 24px; height: 16px; border-radius: 2px; }

        /* --- BOTÕES DE AÇÃO NO TOPO DA TELA DE JOGO --- */
        #logoutBtn, #settingsBtn {
            position: absolute;
            top: 15px;
            z-index: 1000;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        #logoutBtn:hover, #settingsBtn:hover { opacity: 1; }
        #logoutBtn { left: 15px; font-size: 22px; }
        #settingsBtn { right: 15px; }
        

    </style>
</head>
<body>
<div id="congratulationsScreen">
    <h2 data-lang-key="congrats_title">🎉 Parabéns! Novo Recorde! 🎉</h2>
    <p><span data-lang-key="your_score_prefix">Sua pontuação: </span><span id="finalScoreCongrats">0</span></p>
    <button class="btn btn-primary restart-btn" onclick="restartGame()" data-lang-key="play_again_button">Jogar Novamente</button>
</div>

<div class="main-title">
    <span data-lang-key="title_snake_emoji">🐍</span>
    <span data-lang-key="title_j">J</span><span data-lang-key="title_o">o</span><span data-lang-key="title_g">g</span><span data-lang-key="title_o2">o</span>
    <span data-lang-key="title_d">d</span><span data-lang-key="title_a">a</span>
    <span data-lang-key="title_c">C</span><span data-lang-key="title_o3">o</span><span data-lang-key="title_b">b</span><span data-lang-key="title_r">r</span><span data-lang-key="title_i">i</span><span data-lang-key="title_n">n</span><span data-lang-key="title_h">h</span><span data-lang-key="title_a2">a</span>
</div>

<div class="game-container" id="loginScreen">
<h1 data-lang-key="welcome_title">Bem-vindo</h1>
<input class="name-input" id="loginUser" placeholder="Usuário" type="text"/>
<input class="name-input" id="loginPass" placeholder="Senha" type="password"/>
<button class="btn btn-primary start-btn" onclick="handleLogin()" data-lang-key="login_button" style="margin-bottom: 0;">Entrar</button>
<p style="margin-top: 15px;" data-lang-key="no_account_text">Ainda não tem conta? <a href="#" onclick="showRegister()" data-lang-key="register_link">Cadastre-se</a></p>
<p style="font-size: 10px; margin-top: 20px; opacity: 0.5;" data-lang-key="developed_by">Desenvolvido por: John Costa</p>
</div>

<div class="game-container" id="registerScreen" style="display:none;">
<h1 data-lang-key="register_title">📝 Cadastro</h1>
<input class="name-input" id="registerUser" placeholder="Usuário" type="text"/>
<input class="name-input" id="registerPass" placeholder="Senha" type="password"/>
<button class="btn btn-primary start-btn" onclick="handleRegister()" data-lang-key="register_button" style="margin-bottom: 0;">Cadastrar</button>
<p style="margin-top: 15px;"><a href="#" onclick="showLogin()" data-lang-key="already_have_account_link">Já tem conta? Entrar</a></p>
</div>

<div class="game-container" id="mainGame" style="display: none;">
    <button id="logoutBtn" onclick="handleLogout()" data-lang-key="logout_button" title="Sair">🚪</button>
    <button id="settingsBtn" onclick="toggleSettings()" title="Configurações">⚙️</button>
    <div class="language-selector">
        <button class="language-selector-button" id="languageButton">
            <img id="currentFlag" src="https://flagsapi.com/BR/flat/64.png" alt="Brazilian Flag">
        </button>
        <div class="language-selector-dropdown" id="languageDropdown">
            <div class="language-selector-option" data-lang="pt">
                <img src="https://flagsapi.com/BR/flat/64.png" alt="Brazilian Flag">
                <span>Português</span>
            </div>
            <div class="language-selector-option" data-lang="en">
                <img src="https://flagsapi.com/US/flat/64.png" alt="USA Flag">
                <span>English</span>
            </div>
            <div class="language-selector-option" data-lang="es">
                <img src="https://flagsapi.com/ES/flat/64.png" alt="Spanish Flag">
                <span>Español</span>
            </div>
        </div>
    </div>

<div class="leaderboard">
    <h3 data-lang-key="top3_title">🏆 TOP 3</h3>
    <div class="leaderboard-item">
        <span>1º <span id="first-name">---</span><span class="leaderboard-difficulty" id="first-difficulty"></span></span>
        <span id="first-score">0</span>
    </div>
    <div class="leaderboard-item">
        <span>2º <span id="second-name">---</span><span class="leaderboard-difficulty" id="second-difficulty"></span></span>
        <span id="second-score">0</span>
    </div>
    <div class="leaderboard-item">
        <span>3º <span id="third-name">---</span><span class="leaderboard-difficulty" id="third-difficulty"></span></span>
        <span id="third-score">0</span>
    </div>
</div>

<div class="player-score-container">
    <div id="loggedUser" data-lang-key="player_name_prefix">Jogador: ---</div>
    <div class="current-score">
        <span id="scorePrefix" data-lang-key="score_prefix">Pontos: </span><span id="score">0</span>
    </div>
</div>

<div class="current-difficulty" id="difficultyDisplay" style="display: none;">
    <span data-lang-key="difficulty_prefix">Dificuldade:</span> <span id="currentDifficultyText">Normal</span>
</div>

<canvas height="320" id="gameCanvas" width="320"></canvas>

<div id="settingsMenu" style="display: none; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; margin-top: 10px;">
    <h3 style="margin-top: 0;" data-lang-key="settings_title">⚙️ Configurações do Jogo</h3>
    <div class="settings-tabs">
        <button class="tab-button selected" onclick="showSettingsTab('general')" data-lang-key="tab_general">Geral</button>
        <button class="tab-button" onclick="showSettingsTab('controls')" data-lang-key="tab_controls">Controles</button>
        <button class="tab-button" onclick="showSettingsTab('account')" data-lang-key="tab_account">Conta</button>
    </div>
    <div id="generalSettings" class="settings-tab-content">
        <label for="snakeColor" data-lang-key="label_snake_color">Cor da Cobrinha:</label>
        <input id="snakeColor" type="color" value="#00b894"/><br/><br/>
        <label for="screenBackgroundColor" data-lang-key="label_screen_background_color">Cor da Tela:</label>
        <input type="color" id="screenBackgroundColor" value="#1a1a1a" /><br /><br />
    </div>
    <div id="controlsSettings" class="settings-tab-content" style="display:none;">
        <label for="sensitivityRange" data-lang-key="label_button_sensitivity">Sensibilidade dos Botões:</label>
        <input id="sensitivityRange" max="10" min="1" type="range" value="5"/><br/><br/>
        <label for="joystickModel" data-lang-key="label_joystick_model">Modelo de Joystick:</label>
        <select id="joystickModel" onchange="toggleJoystick()">
            <option value="classic" data-lang-key="option_classic">Clássico</option>
            <option value="floating" data-lang-key="option_floating">Flutuante</option>
        </select><br/><br/>
        <label for="joystickPosition" data-lang-key="label_joystick_position">Posição do Joystick Flutuante:</label>
        <select id="joystickPosition" onchange="updateJoystickPosition()">
            <option value="right" data-lang-key="option_right">Direita</option>
            <option value="left" data-lang-key="option_left">Esquerda</option>
            <option value="center" data-lang-key="option_center">Centro</option>
        </select><br/><br/>
    </div>
    <div id="accountSettings" class="settings-tab-content" style="display:none;">
        <h4 data-lang-key="change_username_title">Mudar Nome de Usuário</h4>
        <input class="name-input" id="newUsername" placeholder="Novo Usuário" type="text"/>
        <input class="name-input" id="currentPassForUsername" placeholder="Sua Senha Atual" type="password"/>
        <button class="btn btn-primary" onclick="handleChangeUsername()" data-lang-key="confirm_button">Confirmar</button>
        <p style="color:red; font-size:12px;" id="usernameChangeError"></p>
        <h4 style="margin-top: 20px;" data-lang-key="change_password_title">Mudar Senha</h4>
        <input class="name-input" id="oldPassword" placeholder="Senha Antiga" type="password"/>
        <input class="name-input" id="newPassword" placeholder="Nova Senha" type="password"/>
        <input class="name-input" id="confirmNewPassword" placeholder="Confirme Nova Senha" type="password"/>
        <button class="btn btn-primary" onclick="handleChangePassword()" data-lang-key="confirm_button_2">Confirmar</button>
        <p style="color:red; font-size:12px;" id="passwordChangeError"></p>
    </div>
    <button class="btn btn-secondary" onclick="closeSettings()" style="margin-top: 20px; width:100%;" data-lang-key="close_button">Fechar</button>
</div>

<div id="startScreen">
    <button class="btn btn-primary start-btn" onclick="startGame()" data-lang-key="start_game_button">Iniciar Jogo</button>
    
    <h3 class="selection-title" data-lang-key="choose_difficulty_title">Escolha a Dificuldade:</h3>
    <div class="difficulty-selection">
        <button class="difficulty-btn easy" onclick="selectDifficulty('easy')" data-lang-key="difficulty_easy_button">🐌<br>Fácil</button>
        <button class="difficulty-btn normal selected" onclick="selectDifficulty('normal')" data-lang-key="difficulty_normal_button">🐍<br>Normal</button>
        <button class="difficulty-btn hard" onclick="selectDifficulty('hard')" data-lang-key="difficulty_hard_button">🚀<br>Difícil</button>
        <button class="difficulty-btn insane" onclick="selectDifficulty('insane')" data-lang-key="difficulty_insane_button">💀<br>Insano</button>
    </div>
    <div class="difficulty-info" id="difficultyInfo">Velocidade média - Perfeito para iniciantes!</div>

    <h3 class="selection-title" data-lang-key="choose_map_title">Escolha o Mapa:</h3>
    <div class="map-selection">
        <button class="difficulty-btn selected" onclick="selectMap('normal')" data-lang-key="map_default_button">🧱<br>Padrão</button>
        <button class="difficulty-btn" onclick="selectMap('no-walls')" data-lang-key="map_no_walls_button">🌌<br>Sem Paredes</button>
    </div>
    <div class="difficulty-info" id="mapInfo">Paredes normais.</div>
</div>

<div class="controls" id="gameControls" style="display: none;">
    <button class="control-btn up" id="upBtn">↑</button>
    <button class="control-btn left" id="leftBtn">←</button>
    <button class="control-btn right" id="rightBtn">→</button>
    <button class="control-btn down" id="downBtn">↓</button>
</div>
<div style="display: flex; justify-content: center;">
    <button class="btn btn-secondary pause-btn" id="pauseBtn" onclick="togglePause()" style="display: none;" data-lang-key="pause_button">⏸️ Pausar</button>
    <button class="btn btn-danger quit-game-btn" id="quitGameBtn" onclick="quitGame()" style="display: none;" data-lang-key="quit_game_button">🚫 Sair</button>
</div>
<div class="instructions" id="gameInstructions" style="display: none; margin-top: 15px;">
    <p data-lang-key="instructions_controls" style="font-size: 12px; opacity: 0.7;">Use os botões para controlar a cobra</p>
    <p data-lang-key="instructions_food" style="font-size: 12px; opacity: 0.7;">Colete a comida vermelha para crescer!</p>
</div>

<div class="game-over" id="gameOver">
<h2>Game Over!</h2>
<p><span id="yourScorePrefix" data-lang-key="your_score_prefix">Sua pontuação: </span><span id="finalScore">0</span></p>
<button class="btn btn-primary restart-btn" onclick="restartGame()" data-lang-key="play_again_button">Jogar Novamente</button>
</div>

</div>

<script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const startScreen = document.getElementById('startScreen');
        const gameControls = document.getElementById('gameControls');
        const pauseBtn = document.getElementById('pauseBtn');
        const quitGameBtn = document.getElementById('quitGameBtn');
        const gameInstructions = document.getElementById('gameInstructions');
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const currentDifficultyText = document.getElementById('currentDifficultyText');
        const difficultyInfo = document.getElementById('difficultyInfo');
        const mapInfo = document.getElementById('mapInfo');

        // --- NOVOS ELEMENTOS ---
        const congratulationsScreen = document.getElementById('congratulationsScreen');
        const finalScoreCongrats = document.getElementById('finalScoreCongrats');
        let fireworksInterval; // Para controlar o intervalo dos fogos

        // Elementos do leaderboard
        const firstName = document.getElementById('first-name');
        const firstScore = document.getElementById('first-score');
        const firstDifficulty = document.getElementById('first-difficulty');
        const secondName = document.getElementById('second-name');
        const secondScore = document.getElementById('second-score');
        const secondDifficulty = document.getElementById('second-difficulty');
        const thirdName = document.getElementById('third-name');
        const thirdScore = document.getElementById('third-score');
        const thirdDifficulty = document.getElementById('third-difficulty');

        let snakeColor;
        let screenBackgroundColor;

        document.getElementById('snakeColor').addEventListener('input', function(e) {
            snakeColor = e.target.value;
        });
        document.getElementById('screenBackgroundColor').addEventListener('input', function(e) {
            screenBackgroundColor = e.target.value;
            document.getElementById('mainGame').style.background = screenBackgroundColor;
        });
        function shadeColor(color, percent) {
            let num = parseInt(color.slice(1),16),
                amt = Math.round(2.55 * percent),
                R = (num >> 16) + amt,
                G = (num >> 8 & 0x00FF) + amt,
                B = (num & 0x0000FF) + amt;
            return "#" + (
                0x1000000 +
                (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 +
                (B<255?B<1?0:B:255)
            ).toString(16).slice(1);
        }
        const difficulties = {
            easy: { speed: 200, name_pt: 'Fácil', name_en: 'Easy', name_es: 'Fácil', description_pt: 'Velocidade lenta - Ideal para relaxar!', description_en: 'Slow speed - Ideal for relaxing!', description_es: 'Velocidad lenta - ¡Ideal para relajarse!', emoji: '🐌', points: 5 },
            normal: { speed: 150, name_pt: 'Normal', name_en: 'Normal', name_es: 'Normal', description_pt: 'Velocidade balanceada - A experiência clássica.', description_en: 'Balanced speed - The classic experience.', description_es: 'Velocidad equilibrada - La experiencia clásica.', emoji: '🐍', points: 10 },
            hard: { speed: 100, name_pt: 'Difícil', name_en: 'Hard', name_es: 'Difícil', description_pt: 'Velocidade rápida - Um bom desafio!', description_en: 'Fast speed - A good challenge!', description_es: 'Velocidad rápida - ¡Un buen desafío!', emoji: '🚀', points: 20 },
            insane: { speed: 70, name_pt: 'Insano', name_en: 'Insane', name_es: 'Insano', description_pt: 'Velocidade extrema - Para os mestres da cobrinha!', description_en: 'Extreme speed - For the snake masters!', description_es: 'Velocidad extrema - ¡Para los maestros de la serpiente!', emoji: '💀', points: 30 }
        };
        let currentDifficulty = 'normal';
        let gameInterval;
        const maps = {
            'normal': { name_pt: 'Padrão', name_en: 'Standard', name_es: 'Estándar', description_pt: 'As paredes são barreiras mortais.', description_en: 'Walls are deadly barriers.', description_es: 'Las paredes son barreras mortales.', wrapAround: false },
            'no-walls': { name_pt: 'Sem Paredes', name_en: 'No Walls', name_es: 'Sin Paredes', description_pt: 'Atravesse as paredes e reapareça do outro lado!', description_en: 'Pass through walls and reappear on the other side!', description_es: '¡Atraviesa las paredes y reaparece del otro lado!', wrapAround: true }
        };
        let currentMap = 'normal';
        const gridSize = 17;
        const tileCount = Math.floor(canvas.width / gridSize);
        let snake = [{x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)}];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let leaderboard = JSON.parse(localStorage.getItem('snakeLeaderboardByMap')) || {};
        let gameRunning = false;
        let gameStarted = false;
        let gamePaused = false;
        // ALTERAÇÃO: Adicionado <br> nos botões de mapa para quebra de linha.
        const translations = {
            'pt': { 'congrats_title': '🎉 Parabéns! Novo Recorde! 🎉', 'title_snake_emoji': '🐍', 'title_j': 'J', 'title_o': 'o', 'title_g': 'g', 'title_o2': 'o', 'title_d': ' d', 'title_a': 'a', 'title_c': ' C', 'title_o3': 'o', 'title_b': 'b', 'title_r': 'r', 'title_i': 'i', 'title_n': 'n', 'title_h': 'h', 'title_a2': 'a', 'welcome_title': 'Bem-vindo', 'login_button': 'Entrar', 'no_account_text': 'Ainda não tem conta?', 'register_link': 'Cadastre-se', 'developed_by': 'Desenvolvido por: John Costa', 'register_title': '📝 Cadastro', 'register_button': 'Cadastrar', 'already_have_account_link': 'Já tem conta? Entrar', 'game_title': '🐍 Jogo da Cobrinha', 'player_name_prefix': 'Jogador:', 'score_prefix': 'Pontos:', 'difficulty_prefix': 'Dificuldade:', 'top3_title': '🏆 TOP 3', 'logout_button': 'Sair', 'settings_title': '⚙️ Configurações', 'tab_general': 'Geral', 'tab_controls': 'Controles', 'tab_account': 'Conta', 'label_snake_color': 'Cor da Cobrinha:', 'label_screen_background_color': 'Cor da Tela:', 'label_button_sensitivity': 'Sensibilidade dos Botões:', 'label_joystick_model': 'Modelo de Joystick:', 'option_classic': 'Clássico', 'option_floating': 'Flutuante', 'label_joystick_position': 'Posição do Joystick Flutuante:', 'option_right': 'Direita', 'option_left': 'Esquerda', 'option_center': 'Centro', 'change_username_title': 'Mudar Nome de Usuário', 'confirm_button': 'Confirmar', 'change_password_title': 'Mudar Senha', 'confirm_button_2': 'Confirmar', 'close_button': 'Fechar', 'start_game_button': 'Iniciar Jogo', 'choose_difficulty_title': 'Escolha a Dificuldade:', 'difficulty_easy_button': '🐌<br>Fácil', 'difficulty_normal_button': '🐍<br>Normal', 'difficulty_hard_button': '🚀<br>Difícil', 'difficulty_insane_button': '💀<br>Insano', 'choose_map_title': 'Escolha o Mapa:', 'map_default_button': '🧱<br>Padrão', 'map_no_walls_button': '🌌<br>Sem Paredes', 'pause_button': '⏸️ Pausar', 'quit_game_button': '🚫 Sair', 'game_over_title': 'Game Over!', 'your_score_prefix': 'Sua pontuação:', 'play_again_button': 'Jogar Novamente', 'instructions_controls': 'Use os botões para controlar a cobra', 'instructions_food': 'Colete a comida vermelha para crescer!', 'alert_fill_all_fields': 'Preencha todos os campos', 'alert_user_exists': 'Usuário já existe', 'alert_registration_success': 'Cadastro realizado com sucesso!', 'alert_invalid_credentials': 'Usuário ou senha inválidos', 'alert_confirm_quit': 'Tem certeza que deseja sair da partida atual?', 'alert_no_user_logged_in': 'Nenhum usuário logado.', 'alert_new_username_empty': 'O novo nome de usuário não pode ser vazio.', 'alert_username_taken': 'Este nome de usuário já está em uso.', 'alert_incorrect_current_password': 'Senha atual incorreta.', 'alert_username_changed_leaderboard_reset': 'Nome de usuário alterado com sucesso! Os rankings foram zerados.', 'alert_new_username_same_as_current': 'O novo nome de usuário é o mesmo que o atual.', 'alert_fill_all_password_fields': 'Preencha todos os campos de senha.', 'alert_old_password_incorrect': 'Senha antiga incorreta.', 'alert_new_passwords_dont_match': 'A nova senha e a confirmação não coincidem.', 'alert_password_changed_success': 'Senha alterada com sucesso!', 'alert_new_password_same_as_old': 'A nova senha não pode ser igual à antiga.', 'password_min_length': 'A senha deve ter no mínimo {minLength} caracteres.', 'password_needs_number': 'A senha deve conter pelo menos um número.', 'password_needs_letter': 'A senha deve conter pelo menos uma letra.' },
            'en': { 'congrats_title': '🎉 Congratulations! New Record! 🎉', 'title_snake_emoji': '🐍', 'title_j': 'S', 'title_o': 'n', 'title_g': 'a', 'title_o2': 'k', 'title_d': 'e', 'title_a': ' G', 'title_c': 'a', 'title_o3': 'm', 'title_b': 'e', 'title_r': '', 'title_i': '', 'title_n': '', 'title_h': '', 'title_a2': '', 'welcome_title': 'Welcome', 'login_button': 'Login', 'no_account_text': 'Don\'t have an account?', 'register_link': 'Sign Up', 'developed_by': 'Developed by: John Costa', 'register_title': '📝 Sign Up', 'register_button': 'Sign Up', 'already_have_account_link': 'Already have an account? Login', 'game_title': '🐍 Snake Game', 'player_name_prefix': 'Player:', 'score_prefix': 'Score:', 'difficulty_prefix': 'Difficulty:', 'top3_title': '🏆 TOP 3', 'logout_button': 'Logout', 'settings_title': '⚙️ Settings', 'tab_general': 'General', 'tab_controls': 'Controls', 'tab_account': 'Account', 'label_snake_color': 'Snake Color:', 'label_screen_background_color': 'Screen Color:', 'label_button_sensitivity': 'Button Sensitivity:', 'label_joystick_model': 'Joystick Model:', 'option_classic': 'Classic', 'option_floating': 'Floating', 'label_joystick_position': 'Floating Joystick Position:', 'option_right': 'Right', 'option_left': 'Left', 'option_center': 'Center', 'change_username_title': 'Change Username', 'confirm_button': 'Confirm', 'change_password_title': 'Change Password', 'confirm_button_2': 'Confirm', 'close_button': 'Close', 'start_game_button': 'Start Game', 'choose_difficulty_title': 'Choose Difficulty:', 'difficulty_easy_button': '🐌<br>Easy', 'difficulty_normal_button': '🐍<br>Normal', 'difficulty_hard_button': '🚀<br>Hard', 'difficulty_insane_button': '💀<br>Insane', 'choose_map_title': 'Choose Map:', 'map_default_button': '🧱<br>Standard', 'map_no_walls_button': '🌌<br>No Walls', 'pause_button': '⏸️ Pause', 'quit_game_button': '🚫 Quit', 'game_over_title': 'Game Over!', 'your_score_prefix': 'Your Score:', 'play_again_button': 'Play Again', 'instructions_controls': 'Use the buttons to control the snake', 'instructions_food': 'Collect red food to grow!', 'alert_fill_all_fields': 'Please fill in all fields', 'alert_user_exists': 'User already exists', 'alert_registration_success': 'Registration successful!', 'alert_invalid_credentials': 'Invalid username or password', 'alert_confirm_quit': 'Are you sure you want to quit the current game?', 'alert_no_user_logged_in': 'No user logged in.', 'alert_new_username_empty': 'New username cannot be empty.', 'alert_username_taken': 'This username is already in use.', 'alert_incorrect_current_password': 'Incorrect current password.', 'alert_username_changed_leaderboard_reset': 'Username changed successfully! Leaderboards have been reset.', 'alert_new_username_same_as_current': 'The new username is the same as the current one.',
            'alert_fill_all_password_fields': 'Please fill in all password fields.', 'alert_old_password_incorrect': 'Incorrect old password.', 'alert_new_passwords_dont_match': 'New password and confirmation do not match.', 'alert_password_changed_success': 'Password changed successfully!', 'alert_new_password_same_as_old': 'New password cannot be the same as the old one.', 'password_min_length': 'Password must be at least {minLength} characters long.', 'password_needs_number': 'Password must contain at least one number.', 'password_needs_letter': 'Password must contain at least one letter.' },
            'es': { 'congrats_title': '🎉 ¡Felicidades! ¡Nuevo Récord! 🎉', 'title_snake_emoji': '🐍', 'title_j': 'J', 'title_o': 'u', 'title_g': 'e', 'title_o2': 'g', 'title_d': 'o', 'title_a': ' d', 'title_c': 'e', 'title_o3': ' l', 'title_b': 'a', 'title_r': ' S', 'title_i': 'e', 'title_n': 'r', 'title_h': 'p', 'title_a2': 'iente', 'welcome_title': 'Bienvenido', 'login_button': 'Iniciar Sesión', 'no_account_text': '¿No tienes cuenta?', 'register_link': 'Regístrate', 'developed_by': 'Desarrollado por: John Costa', 'register_title': '📝 Registro', 'register_button': 'Registrar', 'already_have_account_link': '¿Ya tienes cuenta? Iniciar Sesión', 'game_title': '🐍 Juego de la Serpiente', 'player_name_prefix': 'Jugador:', 'score_prefix': 'Puntos:', 'difficulty_prefix': 'Dificultad:', 'top3_title': '🏆 TOP 3', 'logout_button': 'Salir', 'settings_title': '⚙️ Ajustes', 'tab_general': 'General', 'tab_controls': 'Controles', 'tab_account': 'Cuenta', 'label_snake_color': 'Color de la Serpiente:', 'label_screen_background_color': 'Color de la Pantalla:', 'label_button_sensitivity': 'Sensibilidad de los Botones:', 'label_joystick_model': 'Modelo de Joystick:', 'option_classic': 'Clásico', 'option_floating': 'Flotante', 'label_joystick_position': 'Posición del Joystick Flotante:', 'option_right': 'Derecha', 'option_left': 'Izquierda', 'option_center': 'Centro', 'change_username_title': 'Cambiar Nombre de Usuario', 'confirm_button': 'Confirmar', 'change_password_title': 'Cambiar Contraseña', 'confirm_button_2': 'Confirmar', 'close_button': 'Cerrar', 'start_game_button': 'Iniciar Juego', 'choose_difficulty_title': 'Elige la Dificultad:', 'difficulty_easy_button': '🐌<br>Fácil', 'difficulty_normal_button': '🐍<br>Normal', 'difficulty_hard_button': '🚀<br>Difícil', 'difficulty_insane_button': '💀<br>Insano', 'choose_map_title': 'Elige el Mapa:', 'map_default_button': '🧱<br>Estándar', 'map_no_walls_button': '🌌<br>Sin Paredes', 'pause_button': '⏸️ Pausar', 'quit_game_button': '🚫 Salir', 'game_over_title': '¡Fin del Juego!', 'your_score_prefix': 'Tu puntuación:', 'play_again_button': 'Jugar de Nuevo', 'instructions_controls': 'Usa los botones para controlar la serpiente', 'instructions_food': '¡Recoge la comida roja para crecer!', 'alert_fill_all_fields': 'Por favor, rellene todos los campos', 'alert_user_exists': 'El usuario ya existe', 'alert_registration_success': '¡Registro exitoso!', 'alert_invalid_credentials': 'Usuario o contraseña inválidos', 'alert_confirm_quit': '¿Estás seguro de que quieres salir del juego actual?', 'alert_no_user_logged_in': 'Ningún usuario ha iniciado sesión.', 'alert_new_username_empty': 'El nuevo nombre de usuario no puede estar vacío.', 'alert_username_taken': 'Este nombre de usuario ya está en uso.', 'alert_incorrect_current_password': 'Contraseña actual incorrecta.', 'alert_username_changed_leaderboard_reset': '¡Nombre de usuario cambiado con éxito! Las tablas de clasificación han sido restablecidas.', 'alert_new_username_same_as_current': 'El nuevo nombre de usuario es el mismo que el actual.', 'alert_fill_all_password_fields': 'Por favor, rellene todos los campos de contraseña.', 'alert_old_password_incorrect': 'Contraseña antigua incorrecta.', 'alert_new_passwords_dont_match': 'La nueva contraseña y la confirmación no coinciden.', 'alert_password_changed_success': '¡Contraseña cambiada con éxito!', 'alert_new_password_same_as_old': 'La nueva contraseña no puede ser igual a la antigua.', 'password_min_length': 'La contraseña debe tener al menos {minLength} caracteres.', 'password_needs_number': 'La contraseña debe contener al menos un número.', 'password_needs_letter': 'La contraseña debe contener al menos una letra.' }
        };
        let currentLanguage = localStorage.getItem('snakeGameLanguage') || 'pt';

        function updateContent() {
            const lang = translations[currentLanguage];
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                const text = lang[key];

                if (!text) return;

                if (key.startsWith('title_') && element.closest('.main-title')) {
                    const fullTitle = [
                        lang['title_snake_emoji'], lang['title_j'], lang['title_o'], lang['title_g'], lang['title_o2'],
                        lang['title_d'], lang['title_a'], lang['title_c'], lang['title_o3'], lang['title_b'],
                        lang['title_r'], lang['title_i'], lang['title_n'], lang['title_h'], lang['title_a2']
                    ].join('');
                    document.querySelector('.main-title').textContent = fullTitle.replace(/,/g, ''); 
                    return;
                }
                
                if (key === 'player_name_prefix') {
                    if (currentUser) {
                        element.textContent = `${text} ${currentUser}`;
                    } else {
                        element.textContent = text;
                    }
                } else if (element.placeholder && key) {
                    element.placeholder = text;
                } else if (key === 'no_account_text') {
                    const linkText = lang['register_link'];
                    element.innerHTML = `${text} <a href="#" onclick="showRegister()">${linkText}</a>`;
                } else if (key === 'already_have_account_link') {
                     element.innerHTML = `<a href="#" onclick="showLogin()">${text}</a>`;
                }
                else if (key.endsWith('_button')) { // Simplified check for all buttons needing innerHTML
                    element.innerHTML = text;
                }
                else {
                    element.textContent = text;
                }
            });
            selectDifficulty(currentDifficulty);
            selectMap(currentMap);
        }
        function toggleLanguageDropdown() { document.getElementById('languageDropdown').classList.toggle('show'); }
        
        function selectLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('snakeGameLanguage', lang);
            
            const flagMap = { pt: 'BR', en: 'US', es: 'ES' };
            const flagCode = flagMap[lang] || 'BR';
            document.getElementById('currentFlag').src = `https://flagsapi.com/${flagCode}/flat/64.png`;

            updateContent();
            document.getElementById('languageDropdown').classList.remove('show');
        }

        window.addEventListener('click', function(event) { if (!event.target.closest('.language-selector')) { const dropdown = document.getElementById('languageDropdown'); if (dropdown.classList.contains('show')) { dropdown.classList.remove('show'); } } });
        document.getElementById('languageButton').addEventListener('click', toggleLanguageDropdown);
        document.querySelectorAll('.language-selector-option').forEach(option => { option.addEventListener('click', function() { selectLanguage(this.dataset.lang); }); });
        function initializeLeaderboards() { for (const mapKey in maps) { if (!leaderboard[mapKey]) { leaderboard[mapKey] = [ {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"} ]; } else { leaderboard[mapKey] = leaderboard[mapKey].map(entry => { if (!entry.difficulty) { return {...entry, difficulty: 'normal'}; } return entry; }); } } localStorage.setItem('snakeLeaderboardByMap', JSON.stringify(leaderboard)); }
        initializeLeaderboards();
        updateLeaderboardDisplay();
        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            document.querySelectorAll('.difficulty-selection .difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.difficulty-selection .difficulty-btn.${difficulty}`).classList.add('selected');
            difficultyInfo.textContent = difficulties[difficulty]['description_' + currentLanguage];
        }
        function selectMap(map) {
            currentMap = map;
            document.querySelectorAll('.map-selection .difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.map-selection .difficulty-btn[onclick*="'${map}'"]`).classList.add('selected');
            mapInfo.textContent = maps[map]['description_' + currentLanguage];
            updateLeaderboardDisplay();
        }
        function randomTile() { return Math.floor(Math.random() * tileCount); }
        function generateFood() { food = { x: randomTile(), y: randomTile() }; for (let segment of snake) { if (segment.x === food.x && segment.y === food.y) { generateFood(); return; } } }
        function drawGame() { ctx.fillStyle = '#11131e'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = snakeColor; for (let i = 1; i < snake.length; i++) { ctx.fillRect(snake[i].x * gridSize, snake[i].y * gridSize, gridSize - 2, gridSize - 2); } ctx.fillStyle = shadeColor(snakeColor, -20); ctx.fillRect(snake[0].x * gridSize, snake[0].y * gridSize, gridSize - 2, gridSize - 2); ctx.fillStyle = '#e17055'; ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2); ctx.fillStyle = '#fd79a8'; ctx.fillRect(food.x * gridSize + 2, food.y * gridSize + 2, gridSize - 6, gridSize - 6); }
        function updateGame() {
            if (!gameRunning || gamePaused) return;
            if (dx === 0 && dy === 0) return;
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            if (maps[currentMap].wrapAround) {
                if (head.x < 0) head.x = tileCount - 1; else if (head.x >= tileCount) head.x = 0;
                if (head.y < 0) head.y = tileCount - 1; else if (head.y >= tileCount) head.y = 0;
            } else {
                if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) { gameOver(); return; }
            }
            for (let segment of snake) { if (head.x === segment.x && head.y === segment.y) { gameOver(); return; } }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) { let foodPoints = difficulties[currentDifficulty].points; score += foodPoints; scoreElement.textContent = score; generateFood(); }
            else { snake.pop(); }
        }
        function updateLeaderboardDisplay() {
            const difficultyEmojis = { easy: '🐌', normal: '🐍', hard: '🚀', insane: '💀' };
            const currentMapLeaderboard = leaderboard[currentMap] || [ {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"} ];
            firstName.textContent = currentMapLeaderboard[0].name; firstScore.textContent = currentMapLeaderboard[0].score; firstDifficulty.textContent = currentMapLeaderboard[0].score > 0 ? difficultyEmojis[currentMapLeaderboard[0].difficulty] || '🐍' : '';
            secondName.textContent = currentMapLeaderboard[1].name; secondScore.textContent = currentMapLeaderboard[1].score; secondDifficulty.textContent = currentMapLeaderboard[1].score > 0 ? difficultyEmojis[currentMapLeaderboard[1].difficulty] || '🐍' : '';
            thirdName.textContent = currentMapLeaderboard[2].name; thirdScore.textContent = currentMapLeaderboard[2].score; thirdDifficulty.textContent = currentMapLeaderboard[2].score > 0 ? difficultyEmojis[currentMapLeaderboard[2].difficulty] || '🐍' : '';
        }
        function isNewRecord(score) { const currentMapLeaderboard = leaderboard[currentMap] || []; return score > (currentMapLeaderboard[2] ? currentMapLeaderboard[2].score : 0); }
        function saveScore() {
            const name = currentUser ? currentUser.substring(0, 10).toUpperCase() : "???";
            const newEntry = { name: name, score: score, difficulty: currentDifficulty };
            if (!leaderboard[currentMap]) { leaderboard[currentMap] = [ {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"}, {name: "---", score: 0, difficulty: "normal"} ]; }
            leaderboard[currentMap].push(newEntry);
            leaderboard[currentMap].sort((a, b) => b.score - a.score);
            leaderboard[currentMap] = leaderboard[currentMap].slice(0, 3);
            localStorage.setItem('snakeLeaderboardByMap', JSON.stringify(leaderboard));
            updateLeaderboardDisplay();
        }

        function triggerFireworks() {
            congratulationsScreen.style.display = 'flex';
            function createFirework() {
                const firework = document.createElement('div');
                firework.className = 'firework';
                const colors = ['#ffc700', '#ff0000', '#00ff00', '#0000ff', '#ff00ff', '#00ffff'];
                firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                firework.style.left = Math.random() * window.innerWidth + 'px';
                firework.style.top = Math.random() * window.innerHeight + 'px';
                document.body.appendChild(firework);
                setTimeout(() => { firework.remove(); }, 1200);
            }
            fireworksInterval = setInterval(createFirework, 300);
        }
        
        function startGame() {
            snake = [{x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)}]; dx = 0; dy = 0; score = 0; scoreElement.textContent = score;
            gameRunning = true; gameStarted = true; gamePaused = false;
            startScreen.style.display = 'none'; gameControls.style.display = 'grid'; pauseBtn.style.display = 'inline-block'; quitGameBtn.style.display = 'inline-block'; gameInstructions.style.display = 'block'; difficultyDisplay.style.display = 'block';
            const difficultyConfig = difficulties[currentDifficulty];
            currentDifficultyText.textContent = `${difficultyConfig.emoji} ${difficultyConfig['name_' + currentLanguage]}`;
            generateFood();
            if (gameInterval) { clearInterval(gameInterval); }
            gameInterval = setInterval(gameLoop, difficultyConfig.speed);
        }
        function togglePause() { if (!gameRunning || !gameStarted) return; gamePaused = !gamePaused; pauseBtn.textContent = gamePaused ? translations[currentLanguage]['pause_button_continue'] || '▶️ Continuar' : translations[currentLanguage]['pause_button'] || '⏸️ Pausar'; }
        function quitGame() { if (confirm(translations[currentLanguage]['alert_confirm_quit'])) { restartGame(); } }
        
        function gameOver() {
            gameRunning = false;
            gameStarted = false;
            if (gameInterval) { clearInterval(gameInterval); }
            quitGameBtn.style.display = 'none';

            if (isNewRecord(score) && score > 0) {
                saveScore();
                finalScoreCongrats.textContent = score;
                triggerFireworks();
            } else {
                finalScoreElement.textContent = score;
                gameOverElement.style.display = 'flex';
            }
        }
        function restartGame() {
            if (gameInterval) { clearInterval(gameInterval); }
            if (fireworksInterval) {
                clearInterval(fireworksInterval);
                fireworksInterval = null;
            }
            congratulationsScreen.style.display = 'none';

            snake = [{x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)}];
            dx = 0; dy = 0; score = 0; gameRunning = false; gameStarted = false; gamePaused = false;
            scoreElement.textContent = score;
            gameOverElement.style.display = 'none';
            startScreen.style.display = 'block';
            gameControls.style.display = 'none';
            pauseBtn.style.display = 'none';
            quitGameBtn.style.display = 'none';
            gameInstructions.style.display = 'none';
            difficultyDisplay.style.display = 'none';
            pauseBtn.textContent = translations[currentLanguage]['pause_button'] || '⏸️ Pausar';
            ctx.fillStyle = '#2d3436';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            updateLeaderboardDisplay();
        }

        function gameLoop() { updateGame(); drawGame(); }
        document.getElementById('upBtn').addEventListener('touchstart', (e) => { e.preventDefault(); if (!gameRunning || !gameStarted || dy === 1) return; dx = 0; dy = -1; });
        document.getElementById('downBtn').addEventListener('touchstart', (e) => { e.preventDefault(); if (!gameRunning || !gameStarted || dy === -1) return; dx = 0; dy = 1; });
        document.getElementById('leftBtn').addEventListener('touchstart', (e) => { e.preventDefault(); if (!gameRunning || !gameStarted || dx === 1) return; dx = -1; dy = 0; });
        document.getElementById('rightBtn').addEventListener('touchstart', (e) => { e.preventDefault(); if (!gameRunning || !gameStarted || dx === -1) return; dx = 1; dy = 0; });
        document.addEventListener('keydown', (e) => {
            if (!gameRunning || !gameStarted) return;
            switch(e.key) {
                case 'ArrowUp': if (dy !== 1) { dx = 0; dy = -1; } break;
                case 'ArrowDown': if (dy !== -1) { dx = 0; dy = 1; } break;
                case 'ArrowLeft': if (dx !== 1) { dx = -1; dy = 0; } break;
                case 'ArrowRight': if (dx !== -1) { dx = 1; dy = 0; } break;
                case ' ': togglePause(); break;
            }
        });
        let touchStartY = 0; window.addEventListener('touchstart', function(e) { if (e.touches.length !== 1) return; touchStartY = e.touches[0].clientY; }, { passive: false }); window.addEventListener('touchmove', function(e) { const touchY = e.touches[0].clientY; const touchDiff = touchY - touchStartY; if (touchStartY < 10 && touchDiff > 10) { e.preventDefault(); } }, { passive: false });
        selectDifficulty('normal'); selectMap('normal');
</script>
<div id="floatingJoystick" style="position: fixed; bottom: 40px; right: 40px; width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); display: none; touch-action: none;">
<div id="joystickThumb" style="width: 40px; height: 40px; background: rgba(255,255,255,0.3); border-radius: 50%; position: absolute; left: 40px; top: 40px;"></div>
</div>
<script>
let joystickType = 'classic'; let joystickPosition = 'right';
function toggleJoystick() { joystickType = document.getElementById('joystickModel').value; const classic = document.getElementById('gameControls'); const floating = document.getElementById('floatingJoystick'); if (joystickType === 'classic') { classic.style.display = 'grid'; floating.style.display = 'none'; } else { classic.style.display = 'none'; floating.style.display = 'block'; updateJoystickPosition(); } }
function updateJoystickPosition() { joystickPosition = document.getElementById('joystickPosition').value; const floatingJoystick = document.getElementById('floatingJoystick'); floatingJoystick.style.left = ''; floatingJoystick.style.right = ''; floatingJoystick.style.transform = ''; if (joystickPosition === 'left') { floatingJoystick.style.left = '40px'; } else if (joystickPosition === 'right') { floatingJoystick.style.right = '40px'; } else if (joystickPosition === 'center') { floatingJoystick.style.left = '50%'; floatingJoystick.style.transform = 'translateX(-50%)'; } }
let origin = null;
document.getElementById('floatingJoystick').addEventListener('touchstart', e => { const floatingJoystick = document.getElementById('floatingJoystick'); const touch = e.touches[0]; const rect = floatingJoystick.getBoundingClientRect(); const joystickCenterX = rect.left + rect.width / 2; const joystickCenterY = rect.top + rect.height / 2; const distance = Math.hypot(touch.clientX - joystickCenterX, touch.clientY - joystickCenterY); const maxDistanceToReposition = 100; if (distance < maxDistanceToReposition) { let newLeft = touch.clientX - rect.width / 2; let newTop = touch.clientY - rect.height / 2; newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - rect.width)); newTop = Math.max(0, Math.min(newTop, window.innerHeight - rect.height)); floatingJoystick.style.left = `${newLeft}px`; floatingJoystick.style.top = `${newTop}px`; floatingJoystick.style.right = 'auto'; floatingJoystick.style.transform = 'none'; origin = { x: touch.clientX, y: touch.clientY }; } else { origin = { x: touch.clientX, y: touch.clientY }; } }, { passive: false });
document.getElementById('floatingJoystick').addEventListener('touchmove', e => { if (!origin) return; e.preventDefault(); const touch = e.touches[0]; const dxTouch = touch.clientX - origin.x; const dyTouch = touch.clientY - origin.y; const angle = Math.atan2(dyTouch, dxTouch); const distance = Math.min(Math.hypot(dxTouch, dyTouch), 40); const thumb = document.getElementById('joystickThumb'); thumb.style.left = 40 + distance * Math.cos(angle) + 'px'; thumb.style.top = 40 + distance * Math.sin(angle) + 'px'; if (!gameRunning || !gameStarted) return; const sensitivity = parseInt(document.getElementById('sensitivityRange').value); const threshold = sensitivity * 2; if (Math.abs(dxTouch) > Math.abs(dyTouch)) { if (dxTouch > threshold && dx !== -1) { dx = 1; dy = 0; } if (dxTouch < -threshold && dx !== 1) { dx = -1; dy = 0; } } else { if (dyTouch > threshold && dy !== -1) { dx = 0; dy = 1; } if (dyTouch < -threshold && dy !== -1) { dx = 0; dy = -1; } } }, { passive: false });
document.getElementById('floatingJoystick').addEventListener('touchend', e => { origin = null; document.getElementById('joystickThumb').style.left = '40px'; document.getElementById('joystickThumb').style.top = '40px'; });
function toggleSettings() { document.getElementById('settingsMenu').style.display = 'block'; showSettingsTab('general'); }
function closeSettings() { document.getElementById('settingsMenu').style.display = 'none'; saveUserSettings(); showSettingsTab('general'); }
const loginScreen = document.getElementById('loginScreen'); const registerScreen = document.getElementById('registerScreen'); const gameUI = document.getElementById('mainGame'); const loggedUser = document.getElementById('loggedUser'); let currentUser = null; let userSettings = {};
function saveUserSettings() { if (currentUser) { const settingsToSave = { snakeColor: document.getElementById('snakeColor').value, sensitivity: document.getElementById('sensitivityRange').value, joystickModel: document.getElementById('joystickModel').value, screenBackgroundColor: document.getElementById('screenBackgroundColor').value, joystickPosition: document.getElementById('joystickPosition').value, language: currentLanguage }; localStorage.setItem(`settings_${currentUser}`, JSON.stringify(settingsToSave)); } }
function loadUserSettings() {
    if (currentUser) {
        const storedSettings = localStorage.getItem(`settings_${currentUser}`);
        if (storedSettings) {
            userSettings = JSON.parse(storedSettings);
            document.getElementById('snakeColor').value = userSettings.snakeColor || '#00b894';
            document.getElementById('sensitivityRange').value = userSettings.sensitivity || '5';
            document.getElementById('joystickModel').value = userSettings.joystickModel || 'classic';
            document.getElementById('screenBackgroundColor').value = userSettings.screenBackgroundColor || '#1a1a1a';
            document.getElementById('joystickPosition').value = userSettings.joystickPosition || 'right';
            currentLanguage = userSettings.language || 'pt';
            snakeColor = document.getElementById('snakeColor').value;
            screenBackgroundColor = document.getElementById('screenBackgroundColor').value;
            document.getElementById('mainGame').style.background = screenBackgroundColor;
            toggleJoystick(); updateJoystickPosition(); updateContent();
        } else {
            userSettings = { snakeColor: '#00b894', sensitivity: '5', joystickModel: 'classic', screenBackgroundColor: '#1a1a1a', joystickPosition: 'right', language: 'pt' };
            saveUserSettings(); currentLanguage = 'pt'; updateContent();
        }
    }
}
window.onload = () => { loginScreen.style.display = 'block'; gameUI.style.display = 'none'; updateContent(); };
function showRegister() { loginScreen.style.display = 'none'; registerScreen.style.display = 'block'; }
function showLogin() { registerScreen.style.display = 'none'; loginScreen.style.display = 'block'; }
function validatePassword(password) { const minLength = 6; const hasNumber = /[0-9]/.test(password); const hasLetter = /[a-zA-Z]/.test(password); if (password.length < minLength) { return translations[currentLanguage]['password_min_length'].replace('{minLength}', minLength); } if (!hasNumber) { return translations[currentLanguage]['password_needs_number']; } if (!hasLetter) { return translations[currentLanguage]['password_needs_letter']; } return null; }
function handleRegister() {
    const user = document.getElementById('registerUser').value.trim(); const pass = document.getElementById('registerPass').value.trim();
    if (user === '' || pass === '') { alert(translations[currentLanguage]['alert_fill_all_fields']); return; }
    const passwordError = validatePassword(pass); if (passwordError) { alert(passwordError); return; }
    if (localStorage.getItem(`user_${user}`)) { alert(translations[currentLanguage]['alert_user_exists']); return; }
    localStorage.setItem(`user_${user}`, pass);
    userSettings = { snakeColor: '#00b894', sensitivity: '5', joystickModel: 'classic', screenBackgroundColor: '#1a1a1a', joystickPosition: 'right', language: 'pt' };
    localStorage.setItem(`settings_${user}`, JSON.stringify(userSettings));
    alert(translations[currentLanguage]['alert_registration_success']); showLogin();
}
function handleLogin() {
    const user = document.getElementById('loginUser').value.trim(); const pass = document.getElementById('loginPass').value.trim(); const storedPass = localStorage.getItem(`user_${user}`);
    if (storedPass && storedPass === pass) {
        currentUser = user; loginScreen.style.display = 'none'; gameUI.style.display = 'block';
        loadUserSettings();
        loggedUser.textContent = `${translations[currentLanguage]['player_name_prefix']} ${user}`;
        updateLeaderboardDisplay();
    } else { alert(translations[currentLanguage]['alert_invalid_credentials']); }
}
function handleLogout() { saveUserSettings(); localStorage.removeItem("lastUser"); currentUser = null; location.reload(); }
function showSettingsTab(tabId) { document.querySelectorAll('.settings-tab-content').forEach(tab => { tab.style.display = 'none'; }); document.querySelectorAll('.tab-button').forEach(btn => { btn.classList.remove('selected'); }); document.getElementById(tabId + 'Settings').style.display = 'block'; document.querySelector(`.tab-button[onclick*="${tabId}"]`).classList.add('selected'); }
function handleChangeUsername() {
    const newUsername = document.getElementById('newUsername').value.trim(); const currentPass = document.getElementById('currentPassForUsername').value.trim(); const usernameChangeError = document.getElementById('usernameChangeError'); usernameChangeError.textContent = '';
    if (!currentUser) { usernameChangeError.textContent = translations[currentLanguage]['alert_no_user_logged_in']; return; }
    if (newUsername === '') { usernameChangeError.textContent = translations[currentLanguage]['alert_new_username_empty']; return; }
    if (localStorage.getItem(`user_${newUsername}`) && newUsername !== currentUser) { usernameChangeError.textContent = translations[currentLanguage]['alert_username_taken']; return; }
    const storedPass = localStorage.getItem(`user_${currentUser}`); if (storedPass !== currentPass) { usernameChangeError.textContent = translations[currentLanguage]['alert_incorrect_current_password']; return; }
    if (newUsername !== currentUser) {
        localStorage.removeItem(`user_${currentUser}`); localStorage.removeItem(`settings_${currentUser}`);
        localStorage.removeItem(`snakeLeaderboardByMap`); leaderboard = {}; initializeLeaderboards();
        localStorage.setItem(`user_${newUsername}`, currentPass); currentUser = newUsername;
        loggedUser.textContent = `${translations[currentLanguage]['player_name_prefix']} ${currentUser}`;
        saveUserSettings(); updateLeaderboardDisplay();
        alert(translations[currentLanguage]['alert_username_changed_leaderboard_reset']);
    } else { alert(translations[currentLanguage]['alert_new_username_same_as_current']); }
    document.getElementById('newUsername').value = ''; document.getElementById('currentPassForUsername').value = '';
}
function handleChangePassword() {
    const oldPass = document.getElementById('oldPassword').value.trim(); const newPass = document.getElementById('newPassword').value.trim(); const confirmNewPass = document.getElementById('confirmNewPassword').value.trim(); const passwordChangeError = document.getElementById('passwordChangeError'); passwordChangeError.textContent = '';
    if (!currentUser) { passwordChangeError.textContent = translations[currentLanguage]['alert_no_user_logged_in']; return; }
    if (oldPass === '' || newPass === '' || confirmNewPass === '') { passwordChangeError.textContent = translations[currentLanguage]['alert_fill_all_password_fields']; return; }
    const storedPass = localStorage.getItem(`user_${currentUser}`); if (storedPass !== oldPass) { passwordChangeError.textContent = translations[currentLanguage]['alert_old_password_incorrect']; return; }
    if (newPass !== confirmNewPass) { passwordChangeError.textContent = translations[currentLanguage]['alert_new_passwords_dont_match']; return; }
    const passwordError = validatePassword(newPass); if (passwordError) { passwordChangeError.textContent = passwordError; return; }
    if (oldPass === newPass) { passwordChangeError.textContent = translations[currentLanguage]['alert_new_password_same_as_old']; return; }
    localStorage.setItem(`user_${currentUser}`, newPass);
    alert(translations[currentLanguage]['alert_password_changed_success']);
    document.getElementById('oldPassword').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('confirmNewPassword').value = '';
}
document.getElementById('snakeColor').addEventListener('change', saveUserSettings); document.getElementById('sensitivityRange').addEventListener('change', saveUserSettings); document.getElementById('joystickModel').addEventListener('change', saveUserSettings); document.getElementById('screenBackgroundColor').addEventListener('change', saveUserSettings); document.getElementById('joystickPosition').addEventListener('change', saveUserSettings);
showSettingsTab('general');
</script>
</body>
</html>